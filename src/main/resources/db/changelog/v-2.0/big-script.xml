<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="20240312-001" author="Dmitriy">

        <!-- проверка на существование таблицы -->
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="service_points"/>
            </not>
        </preConditions>

        <!-- создание таблицы пунктов обслуживания -->
        <createTable tableName="service_points">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="address" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="phone" type="varchar(20)">
                <constraints unique="true" nullable="false"/>
            </column>
        </createTable>
    </changeSet>




    <changeSet id="20240312-002" author="Dmitriy">

        <!-- проверка на существование таблицы -->
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="producers"/>
            </not>
        </preConditions>

        <!-- создание таблицы производителей -->
        <createTable tableName="producers">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="country" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="foundation_date" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="serial_number" type="varchar(255)">
                <constraints unique="true" nullable="false"/>
            </column>
        </createTable>
    </changeSet>




    <changeSet id="20240312-003" author="Dmitriy">

        <!-- проверка на существование таблицы -->
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="employees"/>
            </not>
        </preConditions>

        <!-- создание таблицы пунктов обслуживания -->
        <createTable tableName="employees">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="address" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="phone" type="varchar(20)">
                <constraints unique="true" nullable="false"/>
            </column>
        </createTable>
    </changeSet>






    <changeSet id="20240312-004" author="Dmitriy">

        <!-- проверка на существование таблицы -->
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="airlines"/>
            </not>
        </preConditions>

        <!-- создание таблицы пунктов обслуживания -->
        <createTable tableName="airlines">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="creation_date" type="timestamp">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>







    <changeSet id="20240312-005" author="Dmitriy">

        <!-- проверка на существование таблицы -->
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="actions"/>
            </not>
        </preConditions>

        <!-- создание таблицы пунктов обслуживания -->
        <createTable tableName="actions">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="action" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="date_of_action" type="timestamp">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>









    <changeSet id="20240312-007" author="Dmitriy">

        <!-- проверка на существование таблицы -->
        <!-- Проверка на существование столбца producer_id -->
        <preConditions onFail="MARK_RAN">
                <tableExists tableName="planes"/>
                <not>
                    <columnExists tableName="planes" columnName="producer_id"/>
                </not>
        </preConditions>


        <!-- добавление fk producer_id -->
        <addColumn tableName="planes">
            <column name="producer_id" type="uuid">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>








    <changeSet id="20240312-008" author="Dmitriy">
        <!-- добавление внешнего ключа для producer_id -->
        <addForeignKeyConstraint baseTableName="planes"
                                 baseColumnNames="producer_id"
                                 constraintName="fk_planes_producer"
                                 referencedTableName="producers"
                                 referencedColumnNames="id"/>
    </changeSet>









    <changeSet id="20240312-009" author="Dmitriy">

        <!-- Проверка на существование таблицы planes -->
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="planes"/>
                <not>
                    <columnExists tableName="planes" columnName="airline_id"/>
                </not>
            </and>
        </preConditions>

        <!-- Добавление fk airline_id -->
        <addColumn tableName="planes">
            <column name="airline_id" type="uuid">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>







    <changeSet id="20240312-010" author="Dmitriy">
        <!-- Добавление внешнего ключа для airline_id -->
        <addForeignKeyConstraint baseTableName="planes"
                                 baseColumnNames="airline_id"
                                 constraintName="fk_planes_airline"
                                 referencedTableName="airlines"
                                 referencedColumnNames="id"/>
    </changeSet>








    <changeSet id="20240312-011" author="Dmitriy">

        <!-- проверка на существование таблицы -->
        <preConditions onFail="MARK_RAN">
                <tableExists tableName="employees"/>
        </preConditions>

        <!-- добавление fk producer_id -->
        <addColumn tableName="employees">
            <column name="producer_id" type="uuid">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>






    <changeSet id="20240312-012" author="Dmitriy">
        <!-- добавление внешнего ключа для producer_id -->
        <addForeignKeyConstraint baseTableName="employees"
                                 baseColumnNames="producer_id"
                                 constraintName="fk_employee_producer"
                                 referencedTableName="producers"
                                 referencedColumnNames="id"/>
    </changeSet>





    <changeSet id="20240312-013" author="Dmitriy">

        <preConditions onFail="MARK_RAN">
                <tableExists tableName="airlines"/>
        </preConditions>

        <addColumn tableName="employees">
            <column name="airline_id" type="uuid">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>





    <changeSet id="20240312-014" author="Dmitriy">
        <addForeignKeyConstraint baseTableName="employees"
                                 baseColumnNames="airline_id"
                                 constraintName="fk_employee_airline"
                                 referencedTableName="airlines"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE"/>
    </changeSet>






    <changeSet id="20240312-015" author="Dmitriy">

        <!-- проверка на существование таблицы -->
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="employee_roles"/>
            </not>
        </preConditions>

        <!-- создание таблицы ролей сотрудников -->
        <createTable tableName="employee_roles">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="role" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>






    <changeSet id="20240312-016" author="Dmitriy">

        <!-- проверка на существование таблицы -->
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="airlines"/>
            <tableExists tableName="employees"/>
        </preConditions>

        <!-- создание таблицы производителей -->
        <createTable tableName="airline_employee">
            <column name="airline_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="employee_id" type="uuid">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>






    <changeSet id="20240312-017" author="Dmitriy">
        <addPrimaryKey constraintName="pk_airline_employee"
                       tableName="airline_employee"
                       columnNames="airline_id, employee_id"/>
    </changeSet>







    <changeSet id="20240312-018" author="Dmitriy">
        <addForeignKeyConstraint baseTableName="airline_employee"
                                 baseColumnNames="airline_id"
                                 constraintName="fk_airline_employee_airline"
                                 referencedTableName="airlines"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE"/>
    </changeSet>






    <changeSet id="20240312-019" author="Dmitriy">
        <addForeignKeyConstraint baseTableName="airline_employee"
                                 baseColumnNames="employee_id"
                                 constraintName="fk_airline_employee_employee"
                                 referencedTableName="employees"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE"/>
    </changeSet>







    <changeSet id="20240312-020" author="Dmitriy">

        <!-- проверка на существование таблицы -->
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="producers"/>
            <tableExists tableName="employees"/>
        </preConditions>

        <!-- создание таблицы производителей -->
        <createTable tableName="producer_employee">
            <column name="producer_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="employee_id" type="uuid">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>



    <changeSet id="20240312-021" author="Dmitriy">
        <addPrimaryKey constraintName="pk_producer_employee"
                       tableName="producer_employee"
                       columnNames="producer_id, employee_id"/>
    </changeSet>




    <changeSet id="20240312-022" author="Dmitriy">
        <addForeignKeyConstraint baseTableName="producer_employee"
                                 baseColumnNames="producer_id"
                                 constraintName="fk_producer_employee_producer"
                                 referencedTableName="producers"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE"/>
    </changeSet>


    <changeSet id="20240312-023" author="Dmitriy">
        <addForeignKeyConstraint baseTableName="producer_employee"
                                 baseColumnNames="employee_id"
                                 constraintName="fk_producer_employee_employee"
                                 referencedTableName="employees"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE"/>
    </changeSet>









    <changeSet id="20240312-024" author="Dmitriy">

        <!-- проверка на существование таблицы -->
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="service_employee"/>
            </not>
        </preConditions>

        <!-- создание таблицы производителей -->
        <createTable tableName="service_employee">
            <column name="employee_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="service_point_id" type="uuid">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>



    <changeSet id="20240312-025" author="Dmitriy">
        <addPrimaryKey constraintName="pk_service_employee"
                       tableName="service_employee"
                       columnNames="employee_id, service_point_id"/>
    </changeSet>



    <changeSet id="20240312-026" author="Dmitriy">
        <addForeignKeyConstraint baseTableName="service_employee"
                                 baseColumnNames="employee_id"
                                 constraintName="fk_service_employee_employee"
                                 referencedTableName="employees"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE"/>
    </changeSet>



    <changeSet id="20240312-027" author="Dmitriy">
        <addForeignKeyConstraint baseTableName="service_employee"
                                 baseColumnNames="service_point_id"
                                 constraintName="fk_service_employee_service_point"
                                 referencedTableName="service_points"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE"/>
    </changeSet>

</databaseChangeLog>